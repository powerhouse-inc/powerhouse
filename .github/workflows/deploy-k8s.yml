name: Deploy to Kubernetes

on:
  workflow_call:
    inputs:
      tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Deploy from main branch (dev) or release/staging/* branches (staging)
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/staging/')
    steps:
      - name: Determine tenant name
        id: tenant
        run: |
          # Map branch to tenant name
          # main branch -> dev tenant
          # release/staging/* -> staging tenant
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "name=dev" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/release/staging/* ]]; then
            echo "name=staging" >> $GITHUB_OUTPUT
          else
            # For future: extract tenant name from branch
            # e.g., release/production -> production
            BRANCH_NAME="${{ github.ref_name }}"
            # Extract second path component (e.g., release/production/1.0.0 -> production)
            echo "name=$(echo $BRANCH_NAME | cut -d'/' -f2)" >> $GITHUB_OUTPUT
          fi

      - name: Checkout k8s cluster repository
        uses: actions/checkout@v4
        with:
          repository: powerhouse-inc/powerhouse-k8s-hosting
          token: ${{ secrets.K8S_REPO_PAT }}
          path: k8s-cluster

      - name: Install yq
        uses: mikefarah/yq@v4

      - name: Check if tenant exists
        id: check-tenant
        run: |
          TENANT_NAME="${{ steps.tenant.outputs.name }}"
          if [ -f "k8s-cluster/tenants/${TENANT_NAME}/powerhouse-values.yaml" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create tenant from template
        if: steps.check-tenant.outputs.exists == 'false'
        run: |
          TENANT_NAME="${{ steps.tenant.outputs.name }}"
          TAG="${{ inputs.tag }}"

          mkdir -p "k8s-cluster/tenants/${TENANT_NAME}"

          cat > "k8s-cluster/tenants/${TENANT_NAME}/powerhouse-values.yaml" << 'EOF'
          # Powerhouse Configuration for ${TENANT_NAME}
          # Auto-generated by deploy-k8s workflow

          global:
            imagePullSecrets:
              enabled: true
              name: ghcr-credentials
              useExisting: true

          database:
            cnpg:
              enabled: true
              name: ${TENANT_NAME}-pg
              instances: 1
              storageClass: hcloud-volumes
              storageSize: 20Gi

              postgresql:
                maxConnections: "400"
                sharedBuffers: "256MB"
                effectiveCacheSize: "1GB"
                workMem: "16MB"

              pooler:
                enabled: true
                instances: 1
                poolMode: transaction
                defaultPoolSize: 25
                maxClientConnections: 200

              backup:
                enabled: true
                destinationPath: s3://cnpg-backups/${TENANT_NAME}/
                endpointURL: http://minio.minio.svc.cluster.local:9000
                credentialsSecret: minio-credentials
                retentionPolicy: "90d"
                useExistingSecret: true

              resources:
                requests:
                  memory: "1Gi"
                  cpu: "1"
                limits:
                  memory: "4Gi"
                  cpu: "4"

              bootstrap:
                database: ${TENANT_NAME}_db
                owner: ${TENANT_NAME}_user

          switchboard:
            enabled: true
            name: switchboard
            replicaCount: 1

            image:
              repository: ghcr.io/powerhouse-inc/powerhouse/switchboard
              tag: "${TAG}"
              pullPolicy: IfNotPresent

            service:
              type: ClusterIP
              port: 80
              targetPort: 3000

            ingress:
              enabled: true
              className: traefik
              host: switchboard.${TENANT_NAME}.vetra.io
              tls:
                enabled: true
                secretName: switchboard-${TENANT_NAME}-tls
              annotations:
                cert-manager.io/cluster-issuer: "letsencrypt-prod"
                traefik.ingress.kubernetes.io/service.serversscheme: h2c

            env:
              PORT: "3000"
              NODE_ENV: development
              ENABLE_TRACING: "true"
              TEMPO_ENDPOINT: "http://tempo.monitoring.svc.cluster.local:4318/v1/traces"
              OTEL_SERVICE_NAME: "switchboard"
              USE_PINO_LOGGER: "true"

            envConfigMap:
              TENANT_ID: "${TENANT_NAME}"
              TENANT_NAME: "${TENANT_NAME}"
              LOG_LEVEL: "info"

            resources:
              requests:
                cpu: 1
                memory: 2Gi
              limits:
                cpu: 2
                memory: 4Gi

            livenessProbe:
              enabled: true
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    wget --post-data='{"query":"{__typename}"}' --header='Content-Type: application/json' -qO- http://localhost:3000/graphql
              initialDelaySeconds: 60
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 6

            readinessProbe:
              enabled: true
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    wget --post-data='{"query":"{__typename}"}' --header='Content-Type: application/json' -qO- http://localhost:3000/graphql
              initialDelaySeconds: 30
              periodSeconds: 5
              timeoutSeconds: 3
              failureThreshold: 6

            securityContext:
              runAsNonRoot: false
              runAsUser: 0
              fsGroup: 0

            autoscaling:
              enabled: false

          connect:
            enabled: true
            name: connect
            replicaCount: 1

            image:
              repository: ghcr.io/powerhouse-inc/powerhouse/connect
              tag: "${TAG}"
              pullPolicy: IfNotPresent

            service:
              type: ClusterIP
              port: 80
              targetPort: 3001

            ingress:
              enabled: true
              className: traefik
              host: connect.${TENANT_NAME}.vetra.io
              tls:
                enabled: true
                secretName: connect-${TENANT_NAME}-tls
              annotations:
                cert-manager.io/cluster-issuer: "letsencrypt-prod"

            env:
              PORT: "3001"
              NODE_ENV: development

            envConfigMap:
              TENANT_ID: "${TENANT_NAME}"
              TENANT_NAME: "${TENANT_NAME}"

            resources:
              requests:
                cpu: 1
                memory: 2Gi
              limits:
                cpu: 2
                memory: 4Gi

            livenessProbe:
              enabled: true
              httpGet:
                path: /
                port: 3001
              initialDelaySeconds: 60
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 6

            readinessProbe:
              enabled: true
              httpGet:
                path: /
                port: 3001
              initialDelaySeconds: 30
              periodSeconds: 5
              timeoutSeconds: 3
              failureThreshold: 6

            securityContext:
              runAsNonRoot: false
              runAsUser: 0
              fsGroup: 0

            autoscaling:
              enabled: false

          academy:
            enabled: true
            name: academy
            replicaCount: 1

            image:
              repository: ghcr.io/powerhouse-inc/powerhouse/academy
              tag: "${TAG}"
              pullPolicy: IfNotPresent

            service:
              type: ClusterIP
              port: 80
              targetPort: 3000

            ingress:
              enabled: true
              className: traefik
              host: academy.${TENANT_NAME}.vetra.io
              tls:
                enabled: true
                secretName: academy-${TENANT_NAME}-tls
              annotations:
                cert-manager.io/cluster-issuer: "letsencrypt-prod"

            env:
              PORT: "3000"
              NODE_ENV: production

            resources:
              requests:
                cpu: 250m
                memory: 512Mi
              limits:
                cpu: 1000m
                memory: 1Gi

            livenessProbe:
              enabled: true
              httpGet:
                path: /
                port: 3000
              initialDelaySeconds: 30
              periodSeconds: 10

            readinessProbe:
              enabled: true
              httpGet:
                path: /
                port: 3000
              initialDelaySeconds: 10
              periodSeconds: 5

            securityContext:
              runAsNonRoot: false
              runAsUser: 0
              fsGroup: 0

            autoscaling:
              enabled: false

          podDisruptionBudget:
            enabled: true
            minAvailable: 1

          serviceMonitor:
            enabled: true
            interval: 30s
            path: /metrics

          glitchtip:
            enabled: true
            dsn: ""
            environment: "${TENANT_NAME}"
            tracingEnabled: "true"

          networkPolicy:
            enabled: true
          EOF

          # Replace placeholders with actual values
          sed -i "s/\${TENANT_NAME}/${TENANT_NAME}/g" "k8s-cluster/tenants/${TENANT_NAME}/powerhouse-values.yaml"
          sed -i "s/\${TAG}/${TAG}/g" "k8s-cluster/tenants/${TENANT_NAME}/powerhouse-values.yaml"

      - name: Update existing tenant image tags
        if: steps.check-tenant.outputs.exists == 'true'
        run: |
          TENANT_NAME="${{ steps.tenant.outputs.name }}"
          TAG="${{ inputs.tag }}"
          VALUES_FILE="k8s-cluster/tenants/${TENANT_NAME}/powerhouse-values.yaml"

          # Update switchboard image tag if enabled
          if yq '.switchboard.enabled' "$VALUES_FILE" | grep -q "true"; then
            yq -i ".switchboard.image.tag = \"${TAG}\"" "$VALUES_FILE"
          fi

          # Update connect image tag if enabled
          if yq '.connect.enabled' "$VALUES_FILE" | grep -q "true"; then
            yq -i ".connect.image.tag = \"${TAG}\"" "$VALUES_FILE"
          fi

          # Update academy image tag if enabled
          if yq '.academy.enabled' "$VALUES_FILE" | grep -q "true"; then
            yq -i ".academy.image.tag = \"${TAG}\"" "$VALUES_FILE"
          fi

      - name: Commit and push changes
        run: |
          cd k8s-cluster
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TENANT_NAME="${{ steps.tenant.outputs.name }}"
          TAG="${{ inputs.tag }}"

          git add "tenants/${TENANT_NAME}/powerhouse-values.yaml"

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ steps.check-tenant.outputs.exists }}" == "false" ]; then
              git commit -m "feat(${TENANT_NAME}): create tenant with image tag ${TAG}"
            else
              git commit -m "chore(${TENANT_NAME}): update image tags to ${TAG}"
            fi
            git push
          fi
