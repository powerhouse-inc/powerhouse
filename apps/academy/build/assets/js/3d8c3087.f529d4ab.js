"use strict";(self.webpackChunk_powerhousedao_academy=self.webpackChunk_powerhousedao_academy||[]).push([[5787],{5035:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/libs-core-351947245adb31bcaf30f953d9d2ddab.jpg"},7361:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"academy/MasteryTrack/WorkWithData/Analytics Engine/typescript/index","title":"Typescript API","description":"Overview","source":"@site/docs/academy/02-MasteryTrack/04-WorkWithData/06-Analytics Engine/typescript/index.md","sourceDirName":"academy/02-MasteryTrack/04-WorkWithData/06-Analytics Engine/typescript","slug":"/academy/MasteryTrack/WorkWithData/Analytics Engine/typescript/","permalink":"/academy/MasteryTrack/WorkWithData/Analytics Engine/typescript/","draft":false,"unlisted":false,"editUrl":"https://github.com/powerhouse-inc/powerhouse-docs/tree/dev/docs/academy/02-MasteryTrack/04-WorkWithData/06-Analytics Engine/typescript/index.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"academySidebar","previous":{"title":"Getting started","permalink":"/academy/MasteryTrack/WorkWithData/Analytics Engine/intro"},"next":{"title":"Memory store","permalink":"/academy/MasteryTrack/WorkWithData/Analytics Engine/typescript/memory"}}');var s=t(5723),r=t(7474);const a={sidebar_position:2},o="Typescript API",c={},l=[{value:"Overview",id:"overview",level:2},{value:"Querying data",id:"querying-data",level:2},{value:"AnalyticsQuery",id:"analyticsquery",level:3},{value:"GroupedPeriodResult",id:"groupedperiodresult",level:3},{value:"A note about times",id:"a-note-about-times",level:3},{value:"Inserting data",id:"inserting-data",level:2},{value:"Subscribing to data changes",id:"subscribing-to-data-changes",level:2},{value:"Store implementations",id:"store-implementations",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"typescript-api",children:"Typescript API"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"The analytics system is broken into several modules, allowing developers to deploy across many environments, for a diverse set of use cases."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"libs",src:t(8503).A+"",width:"1000",height:"578"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"core"})," library contains common data types and abstractions used throughout. The job of the core library is to link together query, storage, and aggregation logic."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"libs",src:t(5035).A+"",width:"1000",height:"578"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"knex"}),", ",(0,s.jsx)(n.code,{children:"pg"}),", and ",(0,s.jsx)(n.code,{children:"browser"})," libraries contain various storage implementations. Finally, the ",(0,s.jsx)(n.code,{children:"graphql"})," library contains types, resolvers, and data types for a GraphQL API on top."]}),"\n",(0,s.jsx)(n.h2,{id:"querying-data",children:"Querying data"}),"\n",(0,s.jsxs)(n.p,{children:["The entry point for data queries in Typescript is the ",(0,s.jsx)(n.code,{children:"AnalyticsQueryEngine"}),". This wraps an ",(0,s.jsx)(n.code,{children:"IAnalyticsStore"})," implementation, which will be discussed in detail later."]}),"\n",(0,s.jsx)(n.p,{children:"In this example, we create a simple in-memory storage engine, compatible with all platforms."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { AnalyticsQueryEngine } from "@powerhousedao/analytics-core";\nimport { MemoryAnalyticsStore } from "@powerhousedao/analytics-memory";\n\nconst engine = new AnalyticsQueryEngine(new MemoryAnalyticsStore());\n'})}),"\n",(0,s.jsx)(n.h3,{id:"analyticsquery",children:"AnalyticsQuery"}),"\n",(0,s.jsxs)(n.p,{children:["Queries use the engine's ",(0,s.jsx)(n.code,{children:"execute"})," function, taking an ",(0,s.jsx)(n.code,{children:"AnalyticsQuery"})," parameter:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"type AnalyticsQuery = {\n  start: DateTime | null;\n  end: DateTime | null;\n  metrics: string[];\n  currency: AnalyticsPath;\n  select: Record<string, AnalyticsPath[]>;\n  granularity: AnalyticsGranularity;\n  lod: Record<string, number | null>;\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each field plays a specific role in determining what data is returned by the analytics engine. Here's a clear and concise description of each:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"start"}),": This is the starting date and time of the series, using Luxon types. See the ",(0,s.jsx)(n.a,{href:"#a-note-about-times",children:"note about times"})," for more information."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"end"}),": This is the ending date and time of the series, using Luxon types. See the ",(0,s.jsx)(n.a,{href:"#a-note-about-times",children:"note about times"})," for more information."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"metrics"}),": Specifies the particular metrics being queried (e.g., ",(0,s.jsx)(n.code,{children:'"budget"'}),"). Each element will refer to the ",(0,s.jsx)(n.code,{children:"name"})," field on the related ",(0,s.jsxs)(n.a,{href:"/academy/MasteryTrack/WorkWithData/Analytics%20Engine/intro#series-and-dimensions",children:[(0,s.jsx)(n.code,{children:"AnalyticsDimension"})," objects"]}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"currency"}),": A path reference to the currency to match (e.g. - ",(0,s.jsx)(n.code,{children:'"usd"'}),")."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"select"}),": This object is a map from metric name to a list of paths (e.g. - ",(0,s.jsx)(n.code,{children:'{ budget: ["/atlas"] }'}),"). These paths are used for matching via the ",(0,s.jsxs)(n.a,{href:"/academy/MasteryTrack/WorkWithData/Analytics%20Engine/intro#series-and-dimensions",children:[(0,s.jsx)(n.code,{children:"AnalyticsDimension"})," objects"]}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"granularity"}),": This field denotes the aggregation period for the data (e.g., ",(0,s.jsx)(n.code,{children:'"monthly"'}),"). A full list of options is available ",(0,s.jsx)(n.a,{href:"/academy/MasteryTrack/WorkWithData/Analytics%20Engine/intro#granularity",children:"here"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"lod"}),": A map from metric name to the level of detail parameter (e.g. - ",(0,s.jsx)(n.code,{children:"3"}),"), described in detail ",(0,s.jsx)(n.a,{href:"/academy/MasteryTrack/WorkWithData/Analytics%20Engine/intro#lods",children:"here"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This query structure allows users to extract detailed and summarized analytics data. A full example will look like:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'const results = await engine.execute({\n  start: DateTime.fromIso("2020-01-01T00:00:00.000Z"),\n  end: "2100-01-01T00:00:00.000Z",\n  currency: AnalyticsPath.fromArray(["DAI"]),\n  metrics: ["Forecast"],\n  select: {\n    report: [\n      AnalyticsPath.fromArray(["atlas", "EcosystemActor", "50", "2023", "11"]),\n    ],\n  },\n  granularity: 0,\n  lod: {},\n});\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This will return an array of ",(0,s.jsx)(n.code,{children:"GroupedPeriodResult"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"groupedperiodresult",children:"GroupedPeriodResult"}),"\n",(0,s.jsx)(n.p,{children:"This object is an aggregate. It represents a combined group of metrics over a time period."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"type GroupedPeriodResult = {\n  period: string;\n  start: DateTime;\n  end: DateTime;\n  rows: Array<{\n    dimensions: Record<string, AnalyticsDimension>;\n    metric: string;\n    unit: string | null;\n    value: number;\n    sum: number;\n  }>;\n};\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"period"}),": Within each series, this field denotes the aggregation period for the data (e.g., ",(0,s.jsx)(n.code,{children:'"monthly"'}),"), with a short description of which month, year, quarter, etc."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"start"}),": This is the starting date and time of the series, using Luxon types. See the ",(0,s.jsx)(n.a,{href:"#a-note-about-times",children:"note about times"})," for more information."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"end"}),": This is the ending date and time of the series, using Luxon types. See the ",(0,s.jsx)(n.a,{href:"#a-note-about-times",children:"note about times"})," for more information."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"rows"}),": Represents the individual records or entries in the data series. Each row corresponds to a unique combination of dimensions for the specified period."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"metric"}),": Within each row, this field specifies the particular metric being measured (e.g., ",(0,s.jsx)(n.code,{children:'"budget"'}),")."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"unit"}),": This indicates the unit of measurement for the metric, such as quantities, currency (e.g., ",(0,s.jsx)(n.code,{children:'"DAI"'}),"), or percentages."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"dimensions"}),": A nested array that provides context for the metric by breaking it down into finer categories or segments, such as ",(0,s.jsx)(n.code,{children:'"project"'})," or ",(0,s.jsx)(n.code,{children:'"category"'}),". Each dimension can contain:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"name"}),": The identifier or key for the dimension."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"path"}),": A structured representation of the dimension's hierarchy or location within a dataset."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"label"}),": A human-readable label for the dimension, which can be used for display purposes."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"description"}),": A brief explanation of the dimension to give users an understanding of what it represents."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"icon"}),": A graphical representation or icon associated with the dimension for easier identification in user interfaces."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"value"}),": The actual numerical value of the metric for each row within the specified period."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"sum"}),": A total or aggregated value of the metric over the entire period, providing a summarized figure."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"a-note-about-times",children:"A note about times"}),"\n",(0,s.jsx)(n.p,{children:"Time is a bit of a sore subject in JavaScript, and we wrestled a bit with how to attack this problem."}),"\n",(0,s.jsxs)(n.p,{children:["First, we started with the builtin ",(0,s.jsx)(n.code,{children:"Date"})," type. Unfortunately, ",(0,s.jsx)(n.code,{children:"Date"})," objects are local-time objects. That means that ",(0,s.jsx)(n.code,{children:"new Date('2024-12-25')"})," might mean one time on this machine and another time on someone elses. While ",(0,s.jsx)(n.code,{children:"Date"})," objects ",(0,s.jsx)(n.em,{children:"can"})," be created using UTC (",(0,s.jsx)(n.code,{children:"new Date('2024-012-25T14:46:22.001Z')"}),"), the resulting ",(0,s.jsx)(n.code,{children:"Date"})," object is still in local time. While ",(0,s.jsx)(n.code,{children:"toISO()"})," does exist, which will output a UTC timestamp, there is no way to tell whether or not the ",(0,s.jsx)(n.code,{children:"Date"})," ",(0,s.jsx)(n.em,{children:"was created"})," with a UTC timestamp and actually creating the time object the user thought they were creating. Imagining calling the ",(0,s.jsx)(n.code,{children:"Date"})," constructor and ending up with a time different than the one you thought you passed in. Eek."]}),"\n",(0,s.jsx)(n.p,{children:"We then considered strings, but those suffer from a load of other problems and they are only really going to be runtime checked."}),"\n",(0,s.jsxs)(n.p,{children:["As this is a time-series analytics system, times are rather important to get right, so we thought we'd stick to a data type that has time, date, and timezone information all in one object. Enter the ",(0,s.jsx)(n.a,{href:"https://moment.github.io/luxon/#/",children:(0,s.jsx)(n.code,{children:"luxon"})})," library. The luxon library had exactly the data object we were looking for. It is difficult (but not impossible) to create a luxon ",(0,s.jsx)(n.code,{children:"DateTime"})," object with a timezone you weren't intending to use."]}),"\n",(0,s.jsx)(n.p,{children:"This is why our analytics API uses these luxon types as inputs and outputs to the system: to make it hard to screw up."}),"\n",(0,s.jsx)(n.h2,{id:"inserting-data",children:"Inserting data"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"IAnalyticsStore"})," interface is the primary entry point for inserting and deleting data. Multiple storage implementations are provided, but for simplicity we can get up and running quickly with the ",(0,s.jsx)(n.a,{href:"#memory",children:(0,s.jsx)(n.code,{children:"MemoryAnalyticsStore"})}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { MemoryAnalyticsStore } from "@powerhousedao/analytics-engine-memory";\n\nconst store = new MemoryAnalyticsStore();\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Data can be added using the ",(0,s.jsx)(n.code,{children:"addSeriesValue"})," method."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'import { DateTime } from "luxon";\nimport { AnalyticsPath } from "@powerhousedao/analytics-engine-core";\n\nconst source = AnalyticsPath.fromString("example/insert");\nawait store.addSeriesValue([\n  {\n    start: DateTime.utc(2021, 1, 1),\n    source,\n    value: 10000,\n    unit: "DAI",\n    metric: "budget",\n    dimensions: {\n      budget: AnalyticsPath.fromString("atlas/legacy/core-units/PE-001"),\n      category: AnalyticsPath.fromString(\n        "atlas/headcount/CompensationAndBenefits/FrontEndEngineering",\n      ),\n      project: source,\n    },\n  },\n]);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"subscribing-to-data-changes",children:"Subscribing to data changes"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"IAnalyticsStore"})," also provides an API for subscribing to data changes. This is achieved by subscribing to an ",(0,s.jsx)(n.code,{children:"AnalyticsPath"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'const store = new MemoryAnalyticsStore();\n\n// subscribe\nconst unsub = store.subscribeToSource(\n  AnalyticsPath.fromString("atlas/"),\n  (source) => {\n    console.log("Atlas data was changed!");\n\n    // decide whether or not to requery\n  },\n);\n\n// elided\n\n// remove your subscription\nunsub();\n'})}),"\n",(0,s.jsx)(n.p,{children:"The subscription API provides many of the same guarantees regarding pathing that the rest of the analytics system does."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'store.subscribeToSource(AnalyticsPath.fromString("atlas/"), handler);\n\n// this will trigger the handler\nawait store.addSeriesValue({ source: AnalyticsPath.fromString("atlas/foo"), ... });\n\n// this will trigger the handler\nawait store.addSeriesValue({ source: AnalyticsPath.fromString("atlas/foo/bar"), ... });\n\n// this will NOT trigger the handler\nawait store.addSeriesValue({ source: AnalyticsPath.fromString("rwa/foo"), ... });\n'})}),"\n",(0,s.jsx)(n.p,{children:"Wildcards can also be used at sub-levels of the path."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'store.subscribeToSource(AnalyticsPath.fromString("atlas/*/test"), handler);\n\n// this will trigger the handler\nawait store.addSeriesValue({ source: AnalyticsPath.fromString("atlas/foo/test"), ... });\n\n// this will trigger the handler\nawait store.addSeriesValue({ source: AnalyticsPath.fromString("atlas/another-thing/test"), ... });\n\n// this will trigger the handler\nawait store.addSeriesValue({ source: AnalyticsPath.fromString("atlas/foo/test/a/b/c"), ... });\n\n// this will NOT trigger the handler\nawait store.addSeriesValue({ source: AnalyticsPath.fromString("rwa/foo/test"), ... });\n'})}),"\n",(0,s.jsx)(n.h2,{id:"store-implementations",children:"Store implementations"}),"\n",(0,s.jsx)(n.p,{children:"Multiple storage implementations are provided, each with comprehensive documentation. See the corresponding docs for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#memory",children:"MemoryAnalyticsStore"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#browser",children:"BrowserAnalyticsStore"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#postgres",children:"PostgresAnalyticsStore"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},7474:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var i=t(2155);const s={},r=i.createContext(s);function a(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(r.Provider,{value:n},e.children)}},8503:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/libs-1a848ea6ad72f16ff41659a870341472.jpg"}}]);